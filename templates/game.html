<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Game Room {{ room_id }}</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"></script>
    <style>
      /* Background */
      * {
        box-sizing: border-box;
        padding: 0;
        margin: 0;
        font-family: Arial, sans-serif;
      }
      body {
        background: url("{{ url_for('static', filename='images/tiles/dead.jpg') }}");
      }
      /* Main game board container */
      #game-board {
        padding: 0px;
        width: 100%;
        position: relative;
        min-height: 800px;
      }
      /* Top area for North player */
      .top-area {
        position: relative;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px 0px;
      }
      /* Player areas with adjusted widths/heights */
      .player-area {
        /* position: absolute; */
        border: 1px solid #fff;
        /* padding: 5px; */
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        text-align: center;
      }
      /* Middle area for east west and center */
      .middle-area {
        position: relative;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        min-height: 600px;
        padding: 40px 0px;
      }
      /* bottom area for the south */
      .bottom-area {
        position: relative;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px 0px;
      }
      #north {
        /* top: 10px; */
        /* left: 50%; */
        /* transform: translateX(-50%); */
        width: 75%;
        margin: 0 auto;
      }
      #south {
        /* bottom: 10px; */
        /* left: 50%; */
        /* transform: translateX(-50%); */
        width: 75%;
      }
      #east {
        /* top: 50%; */
        /* right: 10px; */
        /* transform: translateY(-50%); */
        height: 450px;
        width: 15%;
        min-width: 165px;
      }
      #west {
        /* top: 50%; */
        /* left: 10px; */
        /* transform: translateY(-50%); */
        height: 450px;
        width: 15%;
        min-width: 165px;
      }
      /* Center area */
      #center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        /* position: relative; */
        display: flex;
        justify-content: center;
        align-items: flex-start;
        width: 70%;
        height: 100%;
        text-align: center;
        color: #fff;
      }
      /* Discard pile container with scrolling */
      #discard-pile {
        margin-bottom: 10px;
        max-height: 120px;
        /* overflow-y: auto; */
      }
      #discard-pile img {
        width: 50px;
        margin: 2px;
      }
      /* Hand styling */
      .hand img {
        width: 50px;
        margin: 2px;
        cursor: pointer;
      }
      /* Melds styling */
      .melds {
        margin-top: 5px;
        font-size: 14px;
      }
      .meld-box {
        display: inline-block;
        border: 1px solid #ccc;
        padding: 2px;
        margin: 2px;
        background: rgba(0, 0, 0, 0.3);
      }
      .meld-box img {
        width: 40px;
        margin: 1px;
      }
      /* Button styling */
      #draw-tile-btn,
      #claim-meld-container button {
        padding: 5px 10px;
        margin-top: 10px;
      }
      #claim-meld-container {
        margin-top: 10px;
        display: none;
      }
      /* Chat area styling */
      #chat {
        width: 90%;
        margin: 20px auto;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px;
        color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
      #chat h3 {
        margin: 0 0 10px 0;
        color: #f8d210;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      }
      #chat-messages {
        height: 150px;
        overflow-y: auto;
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 10px;
        margin-bottom: 10px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 4px;
      }
      #chat-messages p {
        margin: 5px 0;
        padding: 5px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      #chat-input {
        width: 80%;
        padding: 8px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.3);
        color: #fff;
        border-radius: 4px;
        margin-right: 10px;
      }
      #chat button {
        padding: 8px 15px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      #chat button:hover {
        background-color: #45a049;
      }
      /* Turn info styling */
      #turn-info {
        text-align: center;
        font-size: 20px;
        color: rgb(0, 239, 60);
        /* margin-top: 10px; */
      }
      /* Error message styling */
      #error-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(255, 77, 77, 0.9);
        color: white;
        padding: 20px 40px;
        border-radius: 8px;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        animation: fadeInOut 3s ease-in-out;
        display: none;
      }

      @keyframes fadeInOut {
        0% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.9);
        }
        10% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
        90% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.9);
        }
      }

      /* Header styling */
      #header {
        text-align: center;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px 0;
        color: #fff;
        /* margin-bottom: 20px; */
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      #header h1 {
        font-size: 3rem;
        margin: 0;
        color: #f8d210;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }

      #header p {
        margin: 10px 0;
        font-size: 1.2rem;
      }

      #header button {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 8px 15px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.3s;
      }

      #header button:hover {
        background-color: #45a049;
      }

      #start-game-btn {
        background-color: #2196f3;
        padding: 10px 20px;
        font-size: 1.1rem;
        margin-top: 10px;
      }

      #start-game-btn:hover {
        background-color: #1976d2;
      }

      #turn-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #4caf50;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        font-size: 18px;
        font-weight: bold;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        animation: fadeInOut 3s ease-in-out;
      }

      @keyframes fadeInOut {
        0% {
          opacity: 0;
          transform: translateY(-10px);
        }
        10% {
          opacity: 1;
          transform: translateY(0);
        }
        90% {
          opacity: 1;
          transform: translateY(0);
        }
        100% {
          opacity: 0;
          transform: translateY(-10px);
        }
      }

      .current-turn {
        background-color: rgba(0, 239, 60, 0.3); /* Light green background */
        border: 2px solid rgb(0, 239, 60); /* Green border */
        transition: background-color 0.3s, border 0.3s;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div id="header">
      <h1>Chinese Mahjong</h1>
      <p>
        Room ID: <span id="room-id">{{ room_id }}</span>
        <button onclick="copyRoomId()">Share</button>
      </p>
    </div>

    <script>
      function copyRoomId() {
        const roomIdText = document.getElementById("room-id").textContent;
        const url = `${window.location.origin}?room_id=${roomIdText}`;
        navigator.clipboard
          .writeText(url)
          .then(() => {
            alert("Room URL copied to clipboard");
          })
          .catch((err) => {
            alert("Failed to copy Room URL");
          });

        /*navigator.clipboard.writeText(roomIdText)
        .then(() => {
          alert("Room ID copied to clipboard");
        })
        .catch(err => {
          alert("Failed to copy Room ID");
        });*/
      }
    </script>

    <div id="error-message"></div>
    <!-- Turn info -->
    <div id="turn-info"></div>

    <div id="turn-notification" style="display: none">It's your turn!</div>

    <div id="game-board">
      <!-- Top div -->
      <div class="top-area">
        <!-- North area -->
        <div id="north" class="player-area">
          <h4 id="north-heading">North</h4>
          <div class="hand" id="north-hand"></div>
          <div class="melds" id="north-melds"></div>
          <div id="north-hand-count"></div>
        </div>
      </div>
      <div class="middle-area">
        <!-- East area -->
        <div id="east" class="player-area">
          <h4 id="east-heading">East</h4>
          <div class="hand" id="east-hand"></div>
          <div class="melds" id="east-melds"></div>
          <div id="east-hand-count"></div>
        </div>

        <!-- Center area -->
        <div id="center">
          <div id="discard-pile">
            <h4>Discard Pile</h4>
            <!-- <div id="pile"></div> -->
            <div id="pile"></div>
          </div>
          <button id="draw-tile-btn" onclick="drawTile()" style="display: none">
            Draw Tile
          </button>
          <div id="claim-meld-container"></div>
        </div>
        <!-- West area -->
        <div id="west" class="player-area">
          <h4 id="west-heading">West</h4>
          <div class="hand" id="west-hand"></div>
          <div class="melds" id="west-melds"></div>
          <div id="west-hand-count"></div>
        </div>
      </div>
      <div class="bottom-area">
        <!-- South area -->
        <div id="south" class="player-area">
          <h4 id="south-heading">South</h4>
          <div class="hand" id="south-hand"></div>
          <div class="melds" id="south-melds"></div>
          <div id="south-hand-count"></div>
        </div>
      </div>
    </div>
    <div style="text-align: center; margin: 20px 0">
      <button id="start-game-btn" onclick="startGame()">Start Game</button>
    </div>

    <!-- Chat Area -->
    <div id="chat">
      <h3>Chat</h3>
      <div id="chat-messages"></div>
      <input
        type="text"
        id="chat-input"
        placeholder="Type a message..."
        style="width: 80%"
      />
      <button onclick="sendChat()">Send</button>
    </div>

    <script>
      const socket = io.connect(
        location.protocol + "//" + document.domain + ":" + location.port
      );
      const roomId = "{{ room_id }}";
      const urlParams = new URLSearchParams(window.location.search);
      const username = urlParams.get("username") || "Anonymous";

      let myPosition = null;
      let currentTurn = null;
      let myHand = []; // Local player's hand
      let opponentHandCounts = { north: 0, east: 0, south: 0, west: 0 };
      let playersMelds = {};
      let playersArray = []; // Order of players as received in player_joined event
      let tile_discarded = false; // Flag to check if a tile has been discarded
      // Join room
      socket.emit("join_room", { room: roomId, username: username });

      socket.on("player_joined", function (data) {
        playersArray = data.players; // assume order corresponds to positions: 0: north, 1: east, 2: south, 3: west
        updatePlayerNames();
      });

      socket.on("game_started", function (data) {
        currentTurn = data.current_turn;
        document.getElementById("turn-info").textContent =
          "Current Turn: " + currentTurn;
        updateDrawButton();
        document.getElementById("start-game-btn").style.display = "none";
      });

      socket.on("deal_hand", function (data) {
        myPosition = data.position; // e.g. "north", "east", "south", "west"
        if (myPosition) {
          myHand = data.hand;
          updateHandDisplay();
        }
      });

      socket.on("tile_drawn", function (data) {
        if (myPosition) {
          myHand.push(data.tile);
          updateHandDisplay();
          document.getElementById("draw-tile-btn").style.display = "none";
        }
      });

      socket.on("tile_discarded", function (data) {
        const pileDiv = document.getElementById("pile");
        const img = document.createElement("img");
        img.src = data.tile.image_path;
        img.alt = data.tile.name;
        img.title = data.tile.name + " (discarded by " + data.username + ")";
        pileDiv.appendChild(img);
      });

      socket.on("turn_update", function (data) {
        currentTurn = data.current_turn;
        document.getElementById("turn-info").textContent =
          "Current Turn: " + currentTurn;

        // Remove the highlight from all player areas
        ["north", "east", "south", "west"].forEach(function (pos) {
          const playerArea = document.getElementById(pos);
          playerArea.classList.remove("current-turn");
        });

        // Highlight the current player's area
        const currentPlayerArea = document.getElementById(currentTurn);
        if (currentPlayerArea) {
          currentPlayerArea.classList.add("current-turn");
        }

        if (myPosition === currentTurn) {
          // Show the notification
          const notification = document.getElementById("turn-notification");
          notification.style.display = "block";
          setTimeout(() => {
            notification.style.display = "none";
          }, 3000); // Hide after 3 seconds

          socket.emit("check_meld", { room: roomId, username: username });
        } else {
          document.getElementById("claim-meld-container").style.display =
            "none";
          document.getElementById("draw-tile-btn").style.display = "none";
        }
      });

      socket.on("meld_options", function (data) {
        const options = data.options; // e.g., ['pong', 'chi', 'kong']
        const claimContainer = document.getElementById("claim-meld-container");
        claimContainer.innerHTML = "";
        if (options.length > 0) {
          options.forEach(function (opt) {
            const button = document.createElement("button");
            button.textContent = opt.charAt(0).toUpperCase() + opt.slice(1);
            button.onclick = function () {
              claimMeld(opt);
            };
            claimContainer.appendChild(button);
          });
          claimContainer.style.display = "block";
          tile_discarded = false; // Reset the flag when meld options are available
          document.getElementById("draw-tile-btn").style.display = "none";
        } else {
          claimContainer.style.display = "none";
          // document.getElementById('draw-tile-btn').style.display = 'block';
          document.getElementById("draw-tile-btn").click();
          tile_discarded = false; // Reset the flag when meld options are available
        }
      });

      socket.on("hand_update", function (data) {
        opponentHandCounts = data.hand_counts;
        updateHandDisplay();
      });

      socket.on("update_hand", function (data) {
        myHand = data.hand;
        updateHandDisplay();
      });

      socket.on("meld_update", function (data) {
        playersMelds = data.players_melds;
        updateMelds();
      });

      socket.on("chat_message", function (data) {
        const chatMessages = document.getElementById("chat-messages");
        const p = document.createElement("p");
        const usernameSpan = document.createElement("span");
        usernameSpan.textContent = data.username + ": ";
        usernameSpan.style.color = "#4CAF50"; // Green color for username
        usernameSpan.style.fontWeight = "bold";
        p.appendChild(usernameSpan);
        p.appendChild(document.createTextNode(data.message));
        chatMessages.appendChild(p);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });

      socket.on("meld_claimed", function (data) {
        alert(data.claimed_by + " claimed a " + data.meld_type + " meld.");
        var pileDiv = document.getElementById("pile");
        pileDiv.removeChild(pileDiv.lastElementChild);
        // document.getElementById('draw-tile-btn').style.display = 'none';
      });

      socket.on("game_over", function (data) {
        let tableHtml = "<h3>Game Over! Winner: " + data.winner + "</h3>";
        tableHtml +=
          "<table border='1' style='width:100%; color:#fff;'><tr><th>Player</th><th>Score</th></tr>";
        for (let player in data.score_table) {
          tableHtml +=
            "<tr><td>" +
            player +
            "</td><td>" +
            data.score_table[player] +
            "</td></tr>";
        }
        tableHtml += "</table>";
        document.getElementById("game-board").innerHTML = tableHtml;
      });

      // Display error messages
      socket.on("error", function (data) {
        const errorDiv = document.getElementById("error-message");
        errorDiv.textContent = data.message;
        errorDiv.style.display = "block";
        setTimeout(() => {
          errorDiv.style.display = "none";
        }, 3000);
      });

      // Update the player area headings with player names
      function updatePlayerNames() {
        // Map positions by order: 0->north, 1->east, 2->south, 3->west.
        const posIds = { 0: "north", 1: "east", 2: "south", 3: "west" };
        playersArray.forEach((player, index) => {
          let posId = posIds[index];
          if (document.getElementById(posId + "-heading")) {
            // For local player's area, show "position (your name)"
            if (player === username) {
              document.getElementById(posId + "-heading").textContent =
                posId.charAt(0).toUpperCase() +
                posId.slice(1) +
                " (" +
                username +
                ")";
            } else {
              document.getElementById(posId + "-heading").textContent =
                posId.charAt(0).toUpperCase() +
                posId.slice(1) +
                " (" +
                player +
                ")";
            }
          }
        });
      }

      function updateHandDisplay() {
        ["north", "east", "south", "west"].forEach(function (pos) {
          const handDiv = document.getElementById(pos + "-hand");
          handDiv.innerHTML = "";
          if (pos === myPosition) {
            myHand.forEach(function (tile, index) {
              const img = document.createElement("img");
              img.src = tile.image_path;
              img.alt = tile.name;
              img.title = tile.name;
              img.onclick = function () {
                discardTile(tile.id, index);
              };
              handDiv.appendChild(img);
            });
            document.getElementById(pos + "-hand-count").textContent =
              "Tiles: " + myHand.length;
          } else {
            const count = opponentHandCounts[pos] || 0;
            for (let i = 0; i < count; i++) {
              const img = document.createElement("img");
              img.src =
                "{{ url_for('static', filename='images/tiles/concealed.jpg') }}";
              img.alt = "Tile";
              handDiv.appendChild(img);
            }
            document.getElementById(pos + "-hand-count").textContent =
              "Tiles: " + count;
          }
        });
      }

      function updateMelds() {
        ["north", "east", "south", "west"].forEach(function (pos) {
          const meldsDiv = document.getElementById(pos + "-melds");
          meldsDiv.innerHTML = "";
          if (playersMelds && playersMelds[pos]) {
            playersMelds[pos].forEach(function (meld) {
              const meldBox = document.createElement("div");
              meldBox.className = "meld-box";
              const meldLabel = document.createElement("div");
              meldLabel.textContent = meld.meld_type.toUpperCase();
              meldLabel.style.fontWeight = "bold";
              meldBox.appendChild(meldLabel);
              meld.tiles.forEach(function (tile) {
                const img = document.createElement("img");
                img.src = tile.image_path;
                img.alt = tile.name;
                img.title = tile.name;
                meldBox.appendChild(img);
              });
              meldsDiv.appendChild(meldBox);
            });
          }
        });
      }

      function updateDrawButton(){
        if (myPosition === currentTurn) {
          // Draw button visibility is determined by meld_options event.
        } else {
          document.getElementById("draw-tile-btn").style.display = "none";
        }
      }

      function startGame() {
        socket.emit("start_game", { room: roomId });
      }

      function drawTile() {
        socket.emit("draw_tile", { room: roomId, username: username });
      }

      function discardTile(tileId, index) {
        if (tile_discarded) {
          alert(
            "You have already discarded a tile this turn. Please wait for your next turn."
          );
          return;
        }
        socket.emit("discard_tile", {
          room: roomId,
          username: username,
          tile_id: tileId,
        });
        tile_discarded = true;
        myHand.splice(index, 1);
        updateHandDisplay();
      }

      function claimMeld(meldType) {
        socket.emit("claim_meld", {
          room: roomId,
          username: username,
          meld_type: meldType,
        });
        document.getElementById("claim-meld-container").style.display = "none";
        document.getElementById("draw-tile-btn").style.display = "none";
      }

      function sendChat() {
        const message = document.getElementById("chat-input").value;
        socket.emit("chat_message", {
          room: roomId,
          username: username,
          message: message,
        });
        document.getElementById("chat-input").value = "";
      }
    </script>
  </body>
</html>
